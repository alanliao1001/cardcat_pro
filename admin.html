<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡ç‰‡è²“ Pro å¾Œå°</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f4; padding: 20px; max-width: 800px; margin: 0 auto; }
        .box { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; display:flex; justify-content:space-between; align-items:center; }
        
        button { padding: 8px 16px; cursor: pointer; background: #000; color: #fff; border: none; border-radius: 5px; }
        button.secondary { background: #666; }
        button.danger { background: #d9534f; }
        button.add-btn { background: #2196F3; } /* è—è‰²æ–°å¢éˆ• */
        
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        
        .tab-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; }
        .tab-btn { white-space: nowrap; background: #eee; color: #333; }
        .tab-btn.active { background: #000; color: #fff; }
        
        .rule-row { display: flex; gap: 5px; align-items: center; border-bottom: 1px solid #f0f0f0; padding: 10px 0; }
        #loading { position: fixed; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.9); display:flex; justify-content:center; align-items:center; z-index:999; }
    </style>
</head>
<body>

<div id="loading">æ­£åœ¨è®€å– GitHub è³‡æ–™...</div>

<div class="box">
    <h2>
        1. é¸æ“‡æˆ–æ–°å¢å¡ç‰‡
        <button class="add-btn" onclick="addNewCard()">â• æ–°å¢å¡ç‰‡</button>
    </h2>
    <div id="tabsContainer" class="tab-scroll"></div>
    
    <div id="cardEditor" style="margin-top:20px; border-top:1px solid #eee; padding-top:20px; display:none;">
        <div style="display:flex; justify-content:space-between;">
            <label>å¡ç‰‡åç¨±ï¼š</label>
            <button class="danger" onclick="deleteCurrentCard()" style="font-size:12px; padding:4px 8px;">ğŸ—‘ï¸ åˆªé™¤æ­¤å¡</button>
        </div>
        <input id="editName" onchange="updateCardMeta('name', this.value)">
        <label>åœ–ç‰‡ç¶²å€ï¼š</label>
        <input id="editImg" onchange="updateCardMeta('img', this.value)">
    </div>
</div>

<div class="box" id="ruleBox" style="display:none;">
    <h2>2. æ–°å¢è¦å‰‡</h2>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <input id="inShop" placeholder="åº—å®¶ (ä¾‹: å…¨å®¶)">
        <input id="inRate" placeholder="å›é¥‹ (ä¾‹: 10%)">
        <input id="inScheme" placeholder="æ–¹æ¡ˆ (ä¾‹: è¡Œå‹•æ”¯ä»˜)">
        <input id="inKey" placeholder="é—œéµå­— (ä¾‹: è¶…å•†)">
    </div>
    <button onclick="addRule()" style="width:100%; margin-top:10px;">â• æ–°å¢è‡³åˆ—è¡¨</button>
</div>

<div class="box" id="listBox" style="display:none;">
    <h2>3. è¦å‰‡åˆ—è¡¨</h2>
    <div id="ruleList"></div>
</div>

<div class="box" style="background:#e8f5e9; border:2px solid #4caf50;">
    <h2>4. å­˜æª”æ­¥é©Ÿ</h2>
    <textarea id="outputJson" style="width:100%; height:100px; font-family:monospace;" readonly></textarea>
    <div style="margin-top:10px;">
        <button onclick="copyAndGo()" style="background:#2e7d32; width:100%;">è¤‡è£½ä¸¦å‰å¾€ GitHub å­˜æª” ğŸš€</button>
    </div>
</div>

<script>
    // ==========================================
    // âš ï¸ è«‹ä¿®æ”¹ç‚ºä½ çš„ cardcat_pro è·¯å¾‘
    // ==========================================
    const DATA_URL = 'https://raw.githubusercontent.com/alanliao1001/cardcat_pro/refs/heads/main/data.json';
    const GITHUB_EDIT_URL = 'https://github.com/alanliao1001/cardcat_pro/edit/main/data.json';
    // ==========================================

    let appData = null;
    let currentTab = 0;

    async function init() {
        try {
            const res = await fetch(DATA_URL + '?t=' + new Date().getTime());
            appData = await res.json();
            if(!appData.cards) appData.cards = [];
            renderTabs();
            document.getElementById('loading').style.display = 'none';
        } catch(e) { alert("è®€å–å¤±æ•—ï¼š" + e.message); }
    }

    // â˜… æ–°åŠŸèƒ½ï¼šæ¸²æŸ“å‹•æ…‹åˆ†é 
    function renderTabs() {
        const container = document.getElementById('tabsContainer');
        container.innerHTML = '';
        
        if(appData.cards.length === 0) {
            container.innerHTML = '<span style="color:#999; padding:10px;">ç›®å‰æ²’æœ‰å¡ç‰‡ï¼Œè«‹æŒ‰æ–°å¢</span>';
            hideEditor();
            return;
        }

        // é˜²æ­¢åˆªé™¤å¾Œ currentTab è¶…å‡ºç¯„åœ
        if(currentTab >= appData.cards.length) currentTab = appData.cards.length - 1;

        appData.cards.forEach((card, idx) => {
            const btn = document.createElement('button');
            btn.className = `tab-btn ${idx === currentTab ? 'active' : ''}`;
            btn.innerText = card.name;
            btn.onclick = () => { currentTab = idx; renderTabs(); };
            container.appendChild(btn);
        });
        
        showEditor();
    }

    // â˜… æ–°åŠŸèƒ½ï¼šæ–°å¢å¡ç‰‡é‚è¼¯
    function addNewCard() {
        const name = prompt("è«‹è¼¸å…¥æ–°å¡ç‰‡åç¨±ï¼š", "æ–°ä¿¡ç”¨å¡");
        if(name) {
            appData.cards.push({
                id: "c" + Date.now(), // éš¨æ©Ÿ ID
                name: name,
                img: "",
                rules: []
            });
            currentTab = appData.cards.length - 1; // åˆ‡æ›åˆ°æ–°å¡ç‰‡
            renderTabs();
            generateJson();
        }
    }

    // â˜… æ–°åŠŸèƒ½ï¼šåˆªé™¤å¡ç‰‡é‚è¼¯
    function deleteCurrentCard() {
        if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${appData.cards[currentTab].name}ã€å—ï¼Ÿ\næ‰€æœ‰çš„è¦å‰‡éƒ½æœƒæ¶ˆå¤±ä¸”ç„¡æ³•å¾©åŸï¼`)) {
            appData.cards.splice(currentTab, 1);
            currentTab = 0;
            renderTabs();
            generateJson();
        }
    }

    function showEditor() {
        const card = appData.cards[currentTab];
        document.getElementById('cardEditor').style.display = 'block';
        document.getElementById('ruleBox').style.display = 'block';
        document.getElementById('listBox').style.display = 'block';
        
        document.getElementById('editName').value = card.name;
        document.getElementById('editImg').value = card.img;
        
        renderRules();
        generateJson();
    }

    function hideEditor() {
        document.getElementById('cardEditor').style.display = 'none';
        document.getElementById('ruleBox').style.display = 'none';
        document.getElementById('listBox').style.display = 'none';
        generateJson();
    }

    function updateCardMeta(key, val) {
        appData.cards[currentTab][key] = val;
        renderTabs(); // å› ç‚ºæ”¹åæœƒå½±éŸ¿ Tab ä¸Šçš„æ–‡å­—ï¼Œæ‰€ä»¥è¦é‡ç¹ª
    }

    function renderRules() {
        const list = document.getElementById('ruleList');
        list.innerHTML = '';
        const rules = appData.cards[currentTab].rules;
        
        rules.forEach((r, i) => {
            const row = document.createElement('div');
            row.className = 'rule-row';
            row.innerHTML = `
                <div style="flex:2"><b>${r.shop}</b> <span style="color:red">${r.rate}</span><br><small>${r.scheme}</small></div>
                <button class="danger" onclick="delRule(${i})">åˆª</button>
            `;
            list.appendChild(row);
        });
    }

    function addRule() {
        const shop = document.getElementById('inShop').value.trim();
        const rate = document.getElementById('inRate').value.trim();
        if(!shop || !rate) return alert("åº—å®¶èˆ‡å›é¥‹ç‚ºå¿…å¡«");
        
        appData.cards[currentTab].rules.unshift({
            shop: shop, 
            rate: rate, 
            scheme: document.getElementById('inScheme').value.trim(), 
            keyword: document.getElementById('inKey').value.trim() || shop
        });
        
        // æ¸…ç©ºè¼¸å…¥
        document.getElementById('inShop').value = ''; 
        document.getElementById('inRate').value = '';
        document.getElementById('inScheme').value = ''; 
        document.getElementById('inKey').value = '';
        renderRules();
        generateJson();
    }

    function delRule(i) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤è¦å‰‡ï¼Ÿ")) {
            appData.cards[currentTab].rules.splice(i, 1);
            renderRules();
            generateJson();
        }
    }

    function generateJson() {
        document.getElementById('outputJson').value = JSON.stringify(appData, null, 2);
    }

    function copyAndGo() {
        const txt = document.getElementById('outputJson');
        txt.select();
        document.execCommand('copy');
        alert("ä»£ç¢¼å·²è¤‡è£½ï¼å³å°‡è·³è½‰ GitHub...");
        window.open(GITHUB_EDIT_URL, '_blank');
    }

    init();
</script>
</body>
</html>
