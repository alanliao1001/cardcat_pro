<script>
    // 【重要：請依照指示填寫】
    const GITHUB_TOKEN = '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'; // 這裡請填入你的 Classic Token
    const REPO_OWNER = 'alanliao1001'; 
    const REPO_NAME = 'cardcat_pro';
    const FILE_PATH = 'data.json';

    let allData = { cards: [] };
    let currentRules = [];
    let editingRuleIndex = -1;
    let cardModal;

    document.addEventListener('DOMContentLoaded', () => {
        cardModal = new bootstrap.Modal(document.getElementById('cardModal'));
        fetchData();
        setupImageUpload();
        
        document.getElementById('addRuleBtn').addEventListener('click', () => {
            const input = document.getElementById('ruleInput').value.trim();
            if (!input) return;

            if (editingRuleIndex > -1) {
                // 更新特定行
                currentRules[editingRuleIndex] = input;
                editingRuleIndex = -1;
                document.getElementById('addRuleBtn').innerText = "新增/更新規則";
                document.getElementById('addRuleBtn').className = "btn btn-outline-secondary";
            } else {
                // 批次新增：將多行內容轉為陣列
                const newRules = input.split(/\n+/).map(r => r.trim()).filter(r => r !== "");
                currentRules = [...currentRules, ...newRules];
            }
            
            document.getElementById('ruleInput').value = "";
            renderRules();
        });
    });

    // 取得資料庫內容 (加上快取清除機制防止讀到舊資料)
    async function fetchData() {
        try {
            const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}?t=${Date.now()}`, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
            });
            if (!res.ok) throw new Error("讀取失敗");
            const file = await res.json();
            allData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
            renderCards();
        } catch (e) { console.error("Database initialization error:", e); }
    }

    // 渲染規則清單 (優化渲染效能)
    function renderRules() {
        const list = document.getElementById('ruleList');
        const html = currentRules.map((rule, index) => `
            <div class="rule-item shadow-sm">
                <input type="checkbox" class="rule-checkbox form-check-input" data-index="${index}">
                <div class="rule-text text-break">${rule}</div>
                <div class="btn-group border-start ms-2 ps-2">
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="prepareEditRule(${index})">編輯</button>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRule(${index})">✕</button>
                </div>
            </div>
        `).join('');
        list.innerHTML = html;
    }

    // 準備編輯特定規則
    function prepareEditRule(index) {
        editingRuleIndex = index;
        document.getElementById('ruleInput').value = currentRules[index];
        document.getElementById('addRuleBtn').innerText = "確認修改此行";
        document.getElementById('addRuleBtn').className = "btn btn-warning text-dark";
        document.getElementById('ruleInput').focus();
    }

    // 刪除選中的規則
    function deleteSelectedRules() {
        const checkboxes = document.querySelectorAll('.rule-checkbox:checked');
        if (checkboxes.length === 0) return alert("請先勾選規則");
        
        const indexesToDelete = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
        // 由大到小刪除，才不會影響 index
        currentRules = currentRules.filter((_, index) => !indexesToDelete.includes(index));
        renderRules();
    }

    // 核心數據同步 (Debug 關鍵：先 Get SHA 再 Put)
    async function updateGitHub() {
        const btn = event.target;
        btn.disabled = true;
        btn.innerText = "同步中...";

        try {
            // 1. 先獲取最新的 SHA (避免 409 Conflict)
            const getRes = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
            });
            const fileData = await getRes.json();
            const currentSha = fileData.sha;

            // 2. 準備 Base64 資料
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(allData, null, 2))));
            
            // 3. 寫入
            const putRes = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                method: 'PUT',
                headers: { 
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Admin Update: ${new Date().toLocaleString()}`,
                    content: content,
                    sha: currentSha
                })
            });

            if (putRes.ok) {
                alert("卡片貓 Pro 雲端資料同步完畢！");
                cardModal.hide();
                fetchData();
            } else {
                throw new Error("GitHub API 回報錯誤");
            }
        } catch (e) {
            alert("同步失敗！請確認您的 GITHUB_TOKEN 是否正確。");
        } finally {
            btn.disabled = false;
            btn.innerText = "確認儲存到 GitHub";
        }
    }
    
    // ... 其餘渲染與圖片上傳邏輯保持不變 ...
</script>
