<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡ç‰‡è²“ Pro å¾Œå° - å°ˆæ¥­ç‰ˆ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f4f4; padding: 20px; max-width: 900px; margin: 0 auto; color: #333; }
        .box { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; display:flex; justify-content:space-between; align-items:center; font-size: 1.2rem; }
        
        button { padding: 8px 16px; cursor: pointer; background: #000; color: #fff; border: none; border-radius: 5px; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        button.secondary { background: #666; }
        button.danger { background: #d9534f; }
        button.add-btn { background: #2196F3; }
        button.edit-btn { background: #ff9800; color: white; padding: 4px 8px; font-size: 12px; }
        
        input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        
        .tab-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; border-bottom: 2px solid #eee; margin-bottom: 15px; }
        .tab-btn { white-space: nowrap; background: #eee; color: #333; border: 1px solid #ddd; }
        .tab-btn.active { background: #2196F3; color: #fff; border-color: #2196F3; }
        
        /* è¦å‰‡åˆ—è¡¨æ¨£å¼ */
        .rule-row { display: flex; gap: 10px; align-items: center; border-bottom: 1px solid #f0f0f0; padding: 12px 0; }
        .rule-row:hover { background: #fafafa; }
        .rule-info { flex: 1; }
        .rule-check { width: 20px; height: 20px; cursor: pointer; }
        
        #loading { position: fixed; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.9); display:flex; justify-content:center; align-items:center; z-index:999; font-weight: bold; }
        .batch-area { background: #fffde7; padding: 15px; border-radius: 8px; border: 1px dashed #fbc02d; margin-bottom: 15px; }
    </style>
</head>
<body>

<div id="loading">æ­£åœ¨è®€å– GitHub è³‡æ–™...</div>

<div class="box">
    <h2>
        1. é¸æ“‡æˆ–æ–°å¢å¡ç‰‡
        <button class="add-btn" onclick="addNewCard()">â• æ–°å¢å¡ç‰‡</button>
    </h2>
    <div id="tabsContainer" class="tab-scroll"></div>
    
    <div id="cardEditor" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom: 5px;">
            <label><b>å¡ç‰‡åŸºæœ¬è³‡è¨Šï¼š</b></label>
            <button class="danger" onclick="deleteCurrentCard()" style="font-size:12px; padding:4px 8px;">ğŸ—‘ï¸ åˆªé™¤æ­¤å¡</button>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input id="editName" placeholder="å¡ç‰‡åç¨±" oninput="updateCardMeta('name', this.value)">
            <input id="editImg" placeholder="åœ–ç‰‡ç¶²å€" oninput="updateCardMeta('img', this.value)">
        </div>
    </div>
</div>

<div class="box" id="ruleBox" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="border:none; margin:0;">2. è¦å‰‡æ“ä½œ</h2>
        <span id="editModeLabel" style="color: #ff9800; font-weight: bold; display: none;">ğŸ“ ç·¨è¼¯æ¨¡å¼ä¸­</span>
    </div>
    
    <div id="singleInputArea">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
            <input id="inShop" placeholder="åº—å®¶ (ä¾‹: å…¨å®¶)">
            <input id="inRate" placeholder="å›é¥‹ (ä¾‹: 10%)">
            <input id="inScheme" placeholder="æ–¹æ¡ˆ (ä¾‹: è¡Œå‹•æ”¯ä»˜)">
            <input id="inKey" placeholder="é—œéµå­— (ä¸å¡«å‰‡åŒåº—å®¶)">
        </div>
        <button id="mainActionBtn" onclick="addOrUpdateRule()" style="width:100%; background: #4CAF50;">â• æ–°å¢è‡³åˆ—è¡¨</button>
        <button id="cancelEditBtn" onclick="resetInput()" style="width:100%; margin-top:5px; background:#666; display:none;">å–æ¶ˆç·¨è¼¯</button>
    </div>

    <hr>

    <div class="batch-area">
        <label><b>ğŸš€ å¿«é€Ÿæ‰¹æ¬¡æ–°å¢ (æ¯ä¸€è¡Œä¸€æ¢è¦å‰‡)</b></label>
        <textarea id="batchInput" placeholder="æ ¼å¼ï¼šåº—å®¶,å›é¥‹,æ–¹æ¡ˆ&#10;ä¾‹ï¼š&#10;å…¨å®¶,10%,è¡—å£&#10;7-11,5%,ICASH" rows="3" style="margin-top:10px;"></textarea>
        <button onclick="batchAddRules()" style="width:100%; background:#2196F3;">âš¡ æ‰¹æ¬¡åŒ¯å…¥</button>
    </div>
</div>

<div class="box" id="listBox" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>3. è¦å‰‡åˆ—è¡¨</h2>
        <button class="danger" id="multiDelBtn" onclick="deleteSelectedRules()" style="display:none; padding:4px 8px; font-size:12px;">ğŸ—‘ï¸ åˆªé™¤é¸ä¸­é …ç›®</button>
    </div>
    <div id="ruleList"></div>
</div>

<div class="box" style="background:#e8f5e9; border:2px solid #4caf50;">
    <h2>4. å­˜æª”æ­¥é©Ÿ</h2>
    <p style="font-size:13px; color:#2e7d32;">ä¿®æ”¹å¾Œï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•è¤‡è£½ï¼Œå†å› GitHub è¦†è“‹åŸå…§å®¹ã€‚</p>
    <textarea id="outputJson" style="width:100%; height:80px; font-family:monospace; background:#f9fef9;" readonly></textarea>
    <div style="margin-top:10px;">
        <button onclick="copyAndGo()" style="background:#2e7d32; width:100%; font-size:16px; font-weight:bold;">è¤‡è£½ä¸¦å‰å¾€ GitHub å­˜æª” ğŸš€</button>
    </div>
</div>

<script>
    const DATA_URL = 'https://raw.githubusercontent.com/alanliao1001/cardcat_pro/refs/heads/main/data.json';
    const GITHUB_EDIT_URL = 'https://github.com/alanliao1001/cardcat_pro/edit/main/data.json';

    let appData = null;
    let currentTab = 0;
    let editingIndex = -1; // è¿½è¹¤ç›®å‰æ­£åœ¨ç·¨è¼¯ç¬¬å¹¾æ¢è¦å‰‡

    async function init() {
        try {
            const res = await fetch(DATA_URL + '?t=' + new Date().getTime());
            appData = await res.json();
            if(!appData.cards) appData.cards = [];
            renderTabs();
            document.getElementById('loading').style.display = 'none';
        } catch(e) { alert("è®€å–å¤±æ•—ï¼š" + e.message); }
    }

    function renderTabs() {
        const container = document.getElementById('tabsContainer');
        container.innerHTML = '';
        if(appData.cards.length === 0) {
            container.innerHTML = '<span style="color:#999; padding:10px;">ç›®å‰æ²’æœ‰å¡ç‰‡ï¼Œè«‹æŒ‰æ–°å¢</span>';
            hideEditor();
            return;
        }
        if(currentTab >= appData.cards.length) currentTab = appData.cards.length - 1;

        appData.cards.forEach((card, idx) => {
            const btn = document.createElement('button');
            btn.className = `tab-btn ${idx === currentTab ? 'active' : ''}`;
            btn.innerText = card.name || "æœªå‘½åå¡ç‰‡";
            btn.onclick = () => { currentTab = idx; resetInput(); renderTabs(); };
            container.appendChild(btn);
        });
        showEditor();
    }

    function addNewCard() {
        const name = prompt("è«‹è¼¸å…¥æ–°å¡ç‰‡åç¨±ï¼š", "æ–°ä¿¡ç”¨å¡");
        if(name) {
            appData.cards.push({ id: "c" + Date.now(), name: name, img: "", rules: [] });
            currentTab = appData.cards.length - 1;
            renderTabs();
        }
    }

    function deleteCurrentCard() {
        if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${appData.cards[currentTab].name}ã€å—ï¼Ÿ`)) {
            appData.cards.splice(currentTab, 1);
            currentTab = 0;
            renderTabs();
        }
    }

    function showEditor() {
        const card = appData.cards[currentTab];
        document.getElementById('cardEditor').style.display = 'block';
        document.getElementById('ruleBox').style.display = 'block';
        document.getElementById('listBox').style.display = 'block';
        document.getElementById('editName').value = card.name;
        document.getElementById('editImg').value = card.img;
        renderRules();
        generateJson();
    }

    function hideEditor() {
        ['cardEditor', 'ruleBox', 'listBox'].forEach(id => document.getElementById(id).style.display = 'none');
        generateJson();
    }

    function updateCardMeta(key, val) {
        appData.cards[currentTab][key] = val;
        if(key === 'name') {
            const activeTab = document.querySelector('.tab-btn.active');
            if(activeTab) activeTab.innerText = val;
        }
        generateJson();
    }

    // --- è¦å‰‡ç®¡ç†æ ¸å¿ƒåŠŸèƒ½ ---

    function renderRules() {
        const list = document.getElementById('ruleList');
        list.innerHTML = '';
        const rules = appData.cards[currentTab].rules;
        
        rules.forEach((r, i) => {
            const row = document.createElement('div');
            row.className = 'rule-row';
            row.innerHTML = `
                <input type="checkbox" class="rule-check" onchange="toggleMultiDelBtn()">
                <div class="rule-info">
                    <b>${r.shop}</b> <span style="color:red; font-weight:bold;">${r.rate}</span>
                    <br><small style="color:#666">${r.scheme || 'ç„¡æ–¹æ¡ˆ'}</small>
                </div>
                <button class="edit-btn" onclick="prepareEdit(${i})">ç·¨è¼¯</button>
                <button class="danger" style="padding:4px 8px; font-size:12px;" onclick="delRule(${i})">âœ•</button>
            `;
            list.appendChild(row);
        });
        toggleMultiDelBtn();
    }

    // æº–å‚™ç·¨è¼¯
    function prepareEdit(index) {
        editingIndex = index;
        const rule = appData.cards[currentTab].rules[index];
        document.getElementById('inShop').value = rule.shop;
        document.getElementById('inRate').value = rule.rate;
        document.getElementById('inScheme').value = rule.scheme;
        document.getElementById('inKey').value = rule.keyword;
        
        document.getElementById('mainActionBtn').innerText = "ğŸ’¾ ç¢ºèªä¿®æ”¹";
        document.getElementById('mainActionBtn').style.background = "#ff9800";
        document.getElementById('cancelEditBtn').style.display = "block";
        document.getElementById('editModeLabel').style.display = "inline";
        document.getElementById('inShop').focus();
    }

    // æ–°å¢æˆ–æ›´æ–°
    function addOrUpdateRule() {
        const shop = document.getElementById('inShop').value.trim();
        const rate = document.getElementById('inRate').value.trim();
        if(!shop || !rate) return alert("åº—å®¶èˆ‡å›é¥‹ç‚ºå¿…å¡«");

        const newRule = {
            shop: shop,
            rate: rate,
            scheme: document.getElementById('inScheme').value.trim(),
            keyword: document.getElementById('inKey').value.trim() || shop
        };

        if(editingIndex > -1) {
            appData.cards[currentTab].rules[editingIndex] = newRule;
        } else {
            appData.cards[currentTab].rules.unshift(newRule);
        }

        resetInput();
        renderRules();
        generateJson();
    }

    // æ‰¹æ¬¡åŒ¯å…¥
    function batchAddRules() {
        const raw = document.getElementById('batchInput').value.trim();
        if(!raw) return;
        const lines = raw.split('\n');
        lines.forEach(line => {
            const parts = line.split(/[,,ï¼Œ]/); // æ”¯æ´ä¸­è‹±æ–‡é€—è™Ÿ
            if(parts.length >= 2) {
                appData.cards[currentTab].rules.unshift({
                    shop: parts[0].trim(),
                    rate: parts[1].trim(),
                    scheme: parts[2] ? parts[2].trim() : "",
                    keyword: parts[0].trim()
                });
            }
        });
        document.getElementById('batchInput').value = '';
        renderRules();
        generateJson();
    }

    // å¤šé¸åˆªé™¤
    function deleteSelectedRules() {
        const checks = document.querySelectorAll('.rule-check');
        const toKeep = [];
        checks.forEach((ck, idx) => {
            if(!ck.checked) toKeep.push(appData.cards[currentTab].rules[idx]);
        });
        
        if(confirm(`ç¢ºå®šåˆªé™¤é¸ä¸­çš„ ${checks.length - toKeep.length} æ¢è¦å‰‡ï¼Ÿ`)) {
            appData.cards[currentTab].rules = toKeep;
            renderRules();
            generateJson();
        }
    }

    function toggleMultiDelBtn() {
        const anyChecked = Array.from(document.querySelectorAll('.rule-check')).some(c => c.checked);
        document.getElementById('multiDelBtn').style.display = anyChecked ? 'block' : 'none';
    }

    function delRule(i) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤è¦å‰‡ï¼Ÿ")) {
            appData.cards[currentTab].rules.splice(i, 1);
            renderRules();
            generateJson();
        }
    }

    function resetInput() {
        editingIndex = -1;
        document.getElementById('inShop').value = '';
        document.getElementById('inRate').value = '';
        document.getElementById('inScheme').value = '';
        document.getElementById('inKey').value = '';
        document.getElementById('mainActionBtn').innerText = "â• æ–°å¢è‡³åˆ—è¡¨";
        document.getElementById('mainActionBtn').style.background = "#4CAF50";
        document.getElementById('cancelEditBtn').style.display = "none";
        document.getElementById('editModeLabel').style.display = "none";
    }

    function generateJson() {
        document.getElementById('outputJson').value = JSON.stringify(appData, null, 2);
    }

    function copyAndGo() {
        const txt = document.getElementById('outputJson');
        txt.select();
        document.execCommand('copy');
        alert("ä»£ç¢¼å·²è¤‡è£½ï¼å³å°‡è·³è½‰ GitHub...");
        window.open(GITHUB_EDIT_URL, '_blank');
    }

    init();
</script>
</body>
</html>
