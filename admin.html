<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡ç‰‡è²“ Pro å¾Œå° - å°ˆæ¥­ç®¡ç†ç‰ˆ</title>
    <style>
        :root { --primary: #2196F3; --success: #4CAF50; --danger: #d9534f; --warning: #ff9800; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: #f0f2f5; padding: 20px; max-width: 900px; margin: 0 auto; color: #333; line-height: 1.5; }
        .box { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 25px; border: 1px solid #e0e0e0; }
        h2 { margin-top: 0; border-bottom: 2px solid #f0f0f0; padding-bottom: 12px; display:flex; justify-content:space-between; align-items:center; font-size: 1.25rem; }
        
        button { padding: 10px 18px; cursor: pointer; background: #333; color: #fff; border: none; border-radius: 6px; font-weight: 500; transition: all 0.2s; }
        button:hover { filter: brightness(1.2); transform: translateY(-1px); }
        button.danger { background: var(--danger); }
        button.add-btn { background: var(--primary); }
        button.edit-btn { background: var(--warning); color: white; padding: 5px 10px; font-size: 12px; }
        
        input, textarea { padding: 12px; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 12px; font-size: 14px; }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(33,150,243,0.1); }
        
        .tab-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 12px; margin-bottom: 15px; scrollbar-width: thin; }
        .tab-btn { white-space: nowrap; background: #fff; color: #555; border: 1px solid #ddd; padding: 8px 15px; }
        .tab-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 2px 5px rgba(33,150,243,0.3); }
        
        .rule-row { display: flex; gap: 12px; align-items: center; border-bottom: 1px solid #f5f5f5; padding: 15px 0; }
        .rule-row:last-child { border-bottom: none; }
        .rule-info { flex: 1; }
        .rule-check { width: 18px; height: 18px; cursor: pointer; }
        
        #loading { position: fixed; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.95); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:999; font-weight: bold; }
        .batch-area { background: #fffde7; padding: 18px; border-radius: 10px; border: 1px dashed #fbc02d; margin-top: 15px; }
        
        .sticky-footer { position: sticky; bottom: 20px; background: #e8f5e9; border: 2px solid var(--success); z-index: 100; }
    </style>
</head>
<body>

<div id="loading">ğŸ± å¡ç‰‡è²“ Pro æ­£åœ¨é€£ç·š GitHub...</div>

<div class="box">
    <h2>
        1. é¸æ“‡æˆ–æ–°å¢å¡ç‰‡
        <button class="add-btn" onclick="addNewCard()">â• æ–°å¢å¡ç‰‡</button>
    </h2>
    <div id="tabsContainer" class="tab-scroll"></div>
    
    <div id="cardEditor" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom: 8px;">
            <label><b>åŸºæœ¬è³‡è¨Šè¨­å®šï¼š</b></label>
            <button class="danger" onclick="deleteCurrentCard()" style="font-size:12px; padding:5px 10px;">ğŸ—‘ï¸ åˆªé™¤æ­¤å¼µå¡ç‰‡</button>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <input id="editName" placeholder="å¡ç‰‡åç¨± (ä¾‹: å°æ–° FlyGo)" oninput="updateCardMeta('name', this.value)">
            <input id="editImg" placeholder="åœ–ç‰‡ç¶²å€ (ä¾‹: https://...)" oninput="updateCardMeta('img', this.value)">
        </div>
    </div>
</div>

<div class="box" id="ruleBox" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="border:none; margin:0;">2. è¦å‰‡ç·¨è¼¯èˆ‡åŒ¯å…¥</h2>
        <span id="editModeLabel" style="color: var(--warning); font-weight: bold; display: none;">ğŸ“ æ­£åœ¨ç·¨è¼¯ç¾æœ‰è¦å‰‡</span>
    </div>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
        <input id="inShop" placeholder="åº—å®¶ (ä¾‹: UberEats)">
        <input id="inRate" placeholder="å›é¥‹ (ä¾‹: 5%)">
        <input id="inScheme" placeholder="æ–¹æ¡ˆ (ä¾‹: éœ€åˆ·å¯¦é«”å¡)">
        <input id="inKey" placeholder="é—œéµå­— (ä¾‹: å¤–é€, æœå°‹ç”¨)">
    </div>
    <button id="mainActionBtn" onclick="addOrUpdateRule()" style="width:100%; background: var(--success); font-size: 16px;">â• æ–°å¢è¦å‰‡åˆ—è¡¨</button>
    <button id="cancelEditBtn" onclick="resetInput()" style="width:100%; margin-top:8px; background:#888; display:none;">å–æ¶ˆç·¨è¼¯</button>

    <div class="batch-area">
        <label><b>âš¡ æ‰¹æ¬¡å¿«é€ŸåŒ¯å…¥ (æ ¼å¼ï¼šåº—å®¶,å›é¥‹,æ–¹æ¡ˆ,é—œéµå­—)</b></label>
        <textarea id="batchInput" placeholder="ç›´æ¥è²¼ä¸Šå¤šè¡Œè³‡æ–™ï¼Œä¾‹å¦‚ï¼š&#10;å…¨å®¶,10%,è¡—å£æ”¯ä»˜,è¶…å•†&#10;ä¸­æ²¹,5%,ç›´ç‡Ÿç«™,åŠ æ²¹" rows="3" style="margin-top:10px;"></textarea>
        <button onclick="batchAddRules()" style="width:100%; background: var(--primary);">åŸ·è¡Œæ‰¹æ¬¡åŒ¯å…¥</button>
    </div>
</div>

<div class="box" id="listBox" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
        <h2 style="border:none; margin:0;">3. è¦å‰‡æ¸…å–®</h2>
        <button class="danger" id="multiDelBtn" onclick="deleteSelectedRules()" style="display:none; padding:6px 12px; font-size:13px;">ğŸ—‘ï¸ åˆªé™¤å‹¾é¸é …ç›®</button>
    </div>
    <div id="ruleList"></div>
</div>

<div class="box sticky-footer">
    <h2>4. å­˜æª”èˆ‡åŒæ­¥</h2>
    <p style="font-size:13px; color:#2e7d32; margin: 5px 0;">é»æ“ŠæŒ‰éˆ•è¤‡è£½ JSON å¾Œï¼Œå›åˆ° GitHub è¦†è“‹ data.json å…§å®¹å³å¯å®ŒæˆåŒæ­¥ã€‚</p>
    <textarea id="outputJson" style="width:100%; height:60px; font-family:monospace; background:rgba(255,255,255,0.5);" readonly></textarea>
    <button onclick="copyAndGo()" style="background:#2e7d32; width:100%; font-size:18px; font-weight:bold; margin-top:10px;">ä¸€éµè¤‡è£½ä¸¦é–‹å•Ÿ GitHub ğŸš€</button>
</div>

<script>
    const DATA_URL = 'https://raw.githubusercontent.com/alanliao1001/cardcat_pro/refs/heads/main/data.json';
    const GITHUB_EDIT_URL = 'https://github.com/alanliao1001/cardcat_pro/edit/main/data.json';

    let appData = { cards: [] };
    let currentTab = 0;
    let editingIndex = -1;

    async function init() {
        try {
            const res = await fetch(DATA_URL + '?t=' + new Date().getTime());
            appData = await res.json();
            if(!appData.cards) appData.cards = [];
            renderTabs();
            document.getElementById('loading').style.display = 'none';
        } catch(e) { 
            alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª DATA_URL æ˜¯å¦æ­£ç¢ºï¼");
            document.getElementById('loading').innerText = "âŒ è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€";
        }
    }

    function renderTabs() {
        const container = document.getElementById('tabsContainer');
        container.innerHTML = '';
        if(appData.cards.length === 0) {
            container.innerHTML = '<span style="color:#999; padding:10px;">ç›®å‰ç„¡å¡ç‰‡ï¼Œè«‹é»æ“Šå³ä¸Šæ–¹æ–°å¢</span>';
            hideEditor();
            return;
        }
        if(currentTab >= appData.cards.length) currentTab = appData.cards.length - 1;

        appData.cards.forEach((card, idx) => {
            const btn = document.createElement('button');
            btn.className = `tab-btn ${idx === currentTab ? 'active' : ''}`;
            btn.innerText = card.name || "æœªå‘½å";
            btn.onclick = () => { currentTab = idx; resetInput(); renderTabs(); };
            container.appendChild(btn);
        });
        showEditor();
    }

    function showEditor() {
        const card = appData.cards[currentTab];
        ['cardEditor', 'ruleBox', 'listBox'].forEach(id => document.getElementById(id).style.display = 'block');
        document.getElementById('editName').value = card.name;
        document.getElementById('editImg').value = card.img;
        renderRules();
        generateJson();
    }

    function hideEditor() {
        ['cardEditor', 'ruleBox', 'listBox'].forEach(id => document.getElementById(id).style.display = 'none');
        generateJson();
    }

    function updateCardMeta(key, val) {
        appData.cards[currentTab][key] = val;
        if(key === 'name') renderTabs();
        generateJson();
    }

    function renderRules() {
        const list = document.getElementById('ruleList');
        list.innerHTML = '';
        const rules = appData.cards[currentTab].rules || [];
        
        rules.forEach((r, i) => {
            const row = document.createElement('div');
            row.className = 'rule-row';
            row.innerHTML = `
                <input type="checkbox" class="rule-check" onchange="toggleMultiDelBtn()">
                <div class="rule-info">
                    <b style="font-size:16px;">${r.shop}</b> <span style="color:var(--danger); font-weight:bold; margin-left:8px;">${r.rate}</span>
                    <br><small style="color:#777">æ–¹æ¡ˆï¼š${r.scheme || 'ç„¡'} | é—œéµå­—ï¼š${r.keyword || r.shop}</small>
                </div>
                <button class="edit-btn" onclick="prepareEdit(${i})">ç·¨è¼¯</button>
                <button class="danger" style="padding:5px 10px; font-size:12px;" onclick="delRule(${i})">âœ•</button>
            `;
            list.appendChild(row);
        });
        toggleMultiDelBtn();
    }

    function prepareEdit(index) {
        editingIndex = index;
        const rule = appData.cards[currentTab].rules[index];
        document.getElementById('inShop').value = rule.shop;
        document.getElementById('inRate').value = rule.rate;
        document.getElementById('inScheme').value = rule.scheme;
        document.getElementById('inKey').value = rule.keyword;
        
        document.getElementById('mainActionBtn').innerText = "ğŸ’¾ å„²å­˜ä¿®æ”¹å…§å®¹";
        document.getElementById('mainActionBtn').style.background = "var(--warning)";
        document.getElementById('cancelEditBtn').style.display = "block";
        document.getElementById('editModeLabel').style.display = "inline";
        window.scrollTo({ top: document.getElementById('ruleBox').offsetTop - 20, behavior: 'smooth' });
    }

    function addOrUpdateRule() {
        const shop = document.getElementById('inShop').value.trim();
        const rate = document.getElementById('inRate').value.trim();
        if(!shop || !rate) return alert("åº—å®¶åç¨±èˆ‡å›é¥‹æ¯”ä¾‹ç‚ºå¿…å¡«é …ï¼");

        const newRule = {
            shop: shop,
            rate: rate,
            scheme: document.getElementById('inScheme').value.trim(),
            keyword: document.getElementById('inKey').value.trim() || shop
        };

        if(editingIndex > -1) {
            appData.cards[currentTab].rules[editingIndex] = newRule;
        } else {
            appData.cards[currentTab].rules.unshift(newRule);
        }

        resetInput();
        renderRules();
        generateJson();
    }

    function batchAddRules() {
        const raw = document.getElementById('batchInput').value.trim();
        if(!raw) return;
        const lines = raw.split('\n');
        lines.forEach(line => {
            const parts = line.split(/[,,ï¼Œ]/);
            if(parts.length >= 2) {
                const shop = parts[0].trim();
                appData.cards[currentTab].rules.unshift({
                    shop: shop,
                    rate: parts[1] ? parts[1].trim() : "",
                    scheme: parts[2] ? parts[2].trim() : "",
                    keyword: (parts[3] && parts[3].trim()) ? parts[3].trim() : shop
                });
            }
        });
        document.getElementById('batchInput').value = '';
        renderRules();
        generateJson();
    }

    function deleteSelectedRules() {
        const checks = document.querySelectorAll('.rule-check');
        const toKeep = [];
        let count = 0;
        checks.forEach((ck, idx) => {
            if(!ck.checked) toKeep.push(appData.cards[currentTab].rules[idx]);
            else count++;
        });
        
        if(confirm(`ç¢ºå®šè¦åˆªé™¤é¸ä¸­çš„ ${count} æ¢è¦å‰‡å—ï¼Ÿ`)) {
            appData.cards[currentTab].rules = toKeep;
            renderRules();
            generateJson();
        }
    }

    function toggleMultiDelBtn() {
        const anyChecked = Array.from(document.querySelectorAll('.rule-check')).some(c => c.checked);
        document.getElementById('multiDelBtn').style.display = anyChecked ? 'block' : 'none';
    }

    function resetInput() {
        editingIndex = -1;
        ['inShop', 'inRate', 'inScheme', 'inKey'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('mainActionBtn').innerText = "â• æ–°å¢è¦å‰‡åˆ—è¡¨";
        document.getElementById('mainActionBtn').style.background = "var(--success)";
        document.getElementById('cancelEditBtn').style.display = "none";
        document.getElementById('editModeLabel').style.display = "none";
    }

    function addNewCard() {
        const name = prompt("è«‹è¼¸å…¥æ–°å¡ç‰‡åç¨±ï¼š");
        if(name) {
            appData.cards.push({ id: "c" + Date.now(), name: name, img: "", rules: [] });
            currentTab = appData.cards.length - 1;
            renderTabs();
        }
    }

    function deleteCurrentCard() {
        if(confirm(`è­¦å‘Šï¼šç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ã€Œ${appData.cards[currentTab].name}ã€å—ï¼Ÿ`)) {
            appData.cards.splice(currentTab, 1);
            currentTab = 0;
            renderTabs();
        }
    }

    function delRule(i) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤è¦å‰‡ï¼Ÿ")) {
            appData.cards[currentTab].rules.splice(i, 1);
            renderRules();
            generateJson();
        }
    }

    function generateJson() {
        document.getElementById('outputJson').value = JSON.stringify(appData, null, 2);
    }

    function copyAndGo() {
        const txt = document.getElementById('outputJson');
        txt.select();
        document.execCommand('copy');
        alert("JSON å·²è¤‡è£½æˆåŠŸï¼\næ¥ä¸‹ä¾†è«‹åœ¨é–‹å•Ÿçš„ GitHub é é¢ä¸­ï¼Œå…¨é¸è²¼ä¸Šä¸¦ Commitã€‚");
        window.open(GITHUB_EDIT_URL, '_blank');
    }

    init();
</script>
</body>
</html>
